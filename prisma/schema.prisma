// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                Int             @id @default(autoincrement())
  discordId         String          @unique
  name              String?
  avatar            String?
  role              String          @default("USER")
  createdAt         DateTime        @default(now())
  lastLogin         DateTime        @updatedAt

  // Relaciones del sistema de Tickets
  createdTickets    Ticket[]        @relation("CreatedTickets")
  reportedInTickets Ticket[]        @relation("ReportedInTickets")
  assignedTickets   Ticket[]        @relation("AssignedTickets")
  ticketMessages    TicketMessage[]
}

// Nueva tabla para simular las casas/negocios del juego
model Property {
  id         Int     @id @default(autoincrement())
  address    String
  ownerName  String? // En el futuro esto se ligará al ID del personaje
  price      Int
  type       String  // Casa, Negocio, Garaje
  posX       Float
  posY       Float
  posZ       Float
  isOccupied Boolean @default(false)
  status     String  @default("APPROVED") // PENDING, APPROVED, REJECTED
}

// TIPOS DE REPORTE
enum TicketType {
  USER_REPORT     // Reporte a usuario
  FACTION_REPORT  // Reporte a facción
  BUG_REPORT      // Bug del servidor
  ACCOUNT_HELP    // Problema de cuenta
  GENERAL_SUPPORT // Duda general
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  CLOSED
  REJECTED
}

// MODELO DE TICKET (Sirve para todo: Reportes, Bugs, Soporte)
model Ticket {
  id          Int          @id @default(autoincrement())
  type        TicketType
  title       String
  description String       @db.Text
  status      TicketStatus @default(OPEN)

  proofUrl    String?
  
  // Quién lo creó (Corregido a Int)
  creatorId   Int
  creator     User         @relation("CreatedTickets", fields: [creatorId], references: [id])

  // A quién reporta (Corregido a Int)
  reportedUserId Int?
  reportedUser   User?     @relation("ReportedInTickets", fields: [reportedUserId], references: [id])

  // Quién lo atiende (Corregido a Int)
  assignedToId Int?
  assignedTo   User?       @relation("AssignedTickets", fields: [assignedToId], references: [id])

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  // Mensajes dentro del ticket (chat de soporte)
  messages    TicketMessage[]
}

model TicketMessage {
  id        Int      @id @default(autoincrement())
  content   String   @db.Text
  
  ticketId  Int
  ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  // Autor del mensaje (Corregido a Int)
  authorId  Int
  author    User     @relation(fields: [authorId], references: [id])
  
  createdAt DateTime @default(now())
}