generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int       @id @default(autoincrement())
  discordId     String    @unique
  name          String?
  avatar        String?
  role          String    @default("USER")
  createdAt     DateTime  @default(now())
  lastLogin     DateTime  @updatedAt

  // --- RELACIONES CORREGIDAS ---
  
  // 1. Tickets creados por mí
  createdTickets       Ticket[]      @relation("CreatedTickets")
  
  // 2. Tickets asignados a mí (si soy staff)
  assignedTickets      Ticket[]      @relation("AssignedTickets")
  
  // 3. Mensajes que he escrito
  ticketMessages       TicketMessage[]

  // 4. Tickets donde participo (chat)
  participatingTickets Ticket[]      @relation("TicketParticipants")
  
  // 5. Reportes recibidos (Soy el acusado) - ESTA ES LA BUENA
  receivedReports      Ticket[]      @relation("ReportedUser")
  
  isBanned      Boolean   @default(false)

  events               Event[]
}

// Nueva tabla para simular las casas/negocios del juego
model Property {
  id         Int     @id @default(autoincrement())
  address    String
  ownerName  String? 
  price      Int
  type       String  
  posX       Float
  posY       Float
  posZ       Float
  isOccupied Boolean @default(false)
  status     String  @default("APPROVED") 
}

enum TicketType {
  USER_REPORT    
  FACTION_REPORT 
  BUG_REPORT     
  ACCOUNT_HELP   
  GENERAL_SUPPORT 
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  CLOSED
  REJECTED
}

model Ticket {
  id          Int          @id @default(autoincrement())
  type        TicketType
  title       String
  description String       @db.Text
  status      TicketStatus @default(OPEN)

  proofUrl    String?
  
  // Creador
  creatorId   Int
  creator     User         @relation("CreatedTickets", fields: [creatorId], references: [id])

  // Acusado / Reportado
  reportedUserId Int?
  reportedUser   User?     @relation("ReportedUser", fields: [reportedUserId], references: [id])

  // Staff Asignado
  assignedToId Int?
  assignedTo   User?       @relation("AssignedTickets", fields: [assignedToId], references: [id])

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  messages    TicketMessage[]

  participants User[]      @relation("TicketParticipants")
}

model TicketMessage {
  id        Int      @id @default(autoincrement())
  content   String   @db.Text
  
  ticketId  Int
  ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  authorId  Int
  author    User     @relation(fields: [authorId], references: [id])
  
  createdAt DateTime @default(now())
}
model Event {
  id              Int      @id @default(autoincrement())
  
  // Datos Básicos
  title           String
  description     String   @db.Text
  eventDate       DateTime
  flyerUrl        String
  publicImageUrl   String? 
  
  // OJO: Hemos quitado gtawLink porque ya no lo pides en el formulario nuevo.
  
  // Requisitos Técnicos
  needsCars       Boolean  @default(false)
  carsDesc        String?  @db.Text
  needsRadio      Boolean  @default(false)
  needsMapping    Boolean  @default(false)
  mappingDesc     String?  @db.Text
  mappingFiles    String?  @db.Text
  
  // Gestión
  status          EventStatus @default(PENDING)
  rejectionReason String?     @db.Text
  
  // Relaciones
  creatorId       Int
  creator         User     @relation(fields: [creatorId], references: [id])
  
  createdAt       DateTime @default(now())

  subscribers      Json      @default("[]")  // IDs de Discord de interesados (stored as JSON array)
  publicMessageId  String?   // ID del mensaje en Discord
  startNotified    Boolean   @default(false)
  ticketChannelId  String?   // ID del canal de ticket creado
}

enum EventStatus {
  PENDING
  APPROVED
  REJECTED
}