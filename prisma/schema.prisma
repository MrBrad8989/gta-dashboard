generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  discordId String   @unique
  name      String?
  avatar    String?
  role      UserRole @default(USER) // ✅ Usar enum en lugar de String
  createdAt DateTime @default(now())
  lastLogin DateTime @updatedAt
  isBanned  Boolean  @default(false)

  // Relaciones
  createdTickets       Ticket[]        @relation("CreatedTickets")
  assignedTickets      Ticket[]        @relation("AssignedTickets")
  ticketMessages       TicketMessage[]
  participatingTickets Ticket[]        @relation("TicketParticipants")
  receivedReports      Ticket[]        @relation("ReportedUser")
  events               Event[]

  @@index([role])
  @@index([isBanned])
  @@index([createdAt])
}

enum UserRole {
  FOUNDER
  ADMIN
  TRIAL_ADMIN
  SUPPORT
  USER
}

model Property {
  id         Int     @id @default(autoincrement())
  address    String
  ownerName  String?
  price      Int
  type       String
  posX       Float
  posY       Float
  posZ       Float
  isOccupied Boolean @default(false)
  status     String  @default("APPROVED")

  @@index([isOccupied])
  @@index([type])
  @@index([status])
}

enum TicketType {
  USER_REPORT
  FACTION_REPORT
  BUG_REPORT
  ACCOUNT_HELP
  GENERAL_SUPPORT
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  CLOSED
  REJECTED
}

model Ticket {
  id          Int          @id @default(autoincrement())
  type        TicketType
  title       String
  description String       @db.Text
  status      TicketStatus @default(OPEN)
  proofUrl    String? 

  // Creador
  creatorId Int
  creator   User @relation("CreatedTickets", fields: [creatorId], references: [id], onDelete: Cascade) // ✅ onDelete

  // Acusado / Reportado
  reportedUserId Int?
  reportedUser   User? @relation("ReportedUser", fields: [reportedUserId], references: [id], onDelete: SetNull) // ✅ onDelete

  // Staff Asignado
  assignedToId Int? 
  assignedTo   User? @relation("AssignedTickets", fields: [assignedToId], references: [id], onDelete:  SetNull) // ✅ onDelete

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages     TicketMessage[]
  participants User[]          @relation("TicketParticipants")

  @@index([creatorId])
  @@index([status])
  @@index([assignedToId])
  @@index([createdAt])
  @@index([type]) // ✅ Añadido
}

model TicketMessage {
  id          Int      @id @default(autoincrement())
  content     String   @db.Text
  attachments Json?    @default("[]") // URLs de imágenes/videos

  ticketId Int
  ticket   Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  authorId Int
  author   User @relation(fields: [authorId], references: [id], onDelete: Cascade) // ✅ onDelete

  createdAt DateTime @default(now())

  @@index([ticketId]) // ✅ Añadido
  @@index([authorId]) // ✅ Añadido
  @@index([createdAt]) // ✅ Añadido
}

model Event {
  id          Int      @id @default(autoincrement())
  title       String
  description String   @db.Text
  eventDate   DateTime
  flyerUrl    String   @db.Text // ✅ Cambiado a Text para URLs largas
  publicImageUrl String?  @db.Text // ✅ Cambiado a Text

  // Requisitos Técnicos
  needsCars    Boolean @default(false)
  carsDesc     String? @db.Text
  needsRadio   Boolean @default(false)
  needsMapping Boolean @default(false)
  mappingDesc  String? @db.Text
  mappingFiles String? @db.Text

  // Gestión
  status          EventStatus @default(PENDING)
  rejectionReason String?     @db.Text

  // Relaciones
  creatorId Int
  creator   User @relation(fields: [creatorId], references: [id], onDelete: Cascade) // ✅ onDelete

  createdAt DateTime @default(now())

  subscribers     Json    @default("[]")
  publicMessageId String? 
  startNotified   Boolean @default(false)
  ticketChannelId String?

  @@index([creatorId])
  @@index([status])
  @@index([eventDate])
  @@index([createdAt])
}

enum EventStatus {
  PENDING
  APPROVED
  REJECTED
}